<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en-US">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Damion Wilson's Blog</title>

    <script src="d3.min.js" charset="utf-8">
    </script>

    <script>
        if (typeof d3 == 'undefined') {
            document.write(
                unescape(
                    '%3Cscript src="http://d3js.org/d3.v3.min.js"%3E%3C/script%3E'
                )
            )
        }
    </script>

    <link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=PT+Serif:700' rel='stylesheet' type='text/css'>

    <style type="text/css" rel="stylesheet">
        body {
            font-family: 'Open Sans Condensed', sans-serif;
        }

        .sidebar {
            position: fixed;
            display: table;
            left: 0px;
            top: 0px;
            height: 100%;
            padding: 12px;
            margin: 1px;
            background: #8b9b77;
            box-shadow: 6px 6px 5px #888888;
            border-radius: 1px;
            color: white;
            width: 100px;
        }

        .sidebar > header {
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }

        .sidebar > ul {
            padding: 0px;
            margin: 0px;
        }

        .nobullets {
            text-decoration: none;
            display: block;
            list-style-type: none;
        }

        .nobullets > li {
            cursor: pointer;
        }

        .nobullets > li:hover {
            color: yellow;
        }

        .nobullets > li > a {
            text-decoration: none;
        }

        .nobullets > li > a:active,
        .nobullets > li > a:hover {
            color: yellow;
        }

        .main {
            position: relative;
            margin-left: 128px;
            margin-right: 10px;
        }

        .main > div:nth-of-type(1) {
            position: fixed;
            top: 0;
            left: 137px;
            right: 0px;
            padding: 20px;
            margin-top: 2px;
            margin-right: 20px;
            margin-bottom: 50px;
            background: #8b9b77;
            background-image: url('banner.jpg');
            border-bottom: medium thick #202020;
            box-shadow: 6px 6px 5px #888888;
        }

        .main > div:nth-of-type(2) {
            padding-top: 120px;
            margin-left: 10px;
        }

        .main > div:nth-of-type(2) > * {
            display: none;
        }

        /*----------------------------------------*/
        .post-meta {
            display: inline-block;
            font-size: 1.4rem;
            line-height: 1;
            color: #9EABB3;
        }

        .post-meta a{
            color: #9EABB3;
            text-decoration: none;
        }

        .post-meta a:hover{
            text-decoration: underline;
        }

        /*----------------------------------------*/
        .blog-title {
            margin:0;
            font-size:2.2rem;
            letter-spacing:1px;
            font-weight:bold;
            font-family: 'PT Serif', serif;
            text-transform:uppercase;
            color: #f0f060;
        }

        .blog-title a{
            color: inherit;
            text-decoration:none;
        }

        .blog-description{
            margin:0;
            font-size:1.5rem;
            line-height:1em;
            font-weight:normal;
            color: #f0f060;
            letter-spacing:0;
        }

        .linkformat {
            line-height: 20px;
            margin-left: 10px;
            text-align: left;
            padding-top: 10px;
        }

        .linkformat > li {
            font-size: 1.4em;
            margin: 12px;
        }

        .linkformat > li > a {
            text-decoration: none;
        }

        .linkformat > li > a:active,
        .linkformat > li > a:hover {
            text-decoration: underline;
            color: yellow;
        }

        .jumpto {
            position: absolute;
            margin-top: -120px;
        }

        #archive {
            text-indent: 10px;
            padding-top: 5px;
        }

        #archive > li {
        }

        .tableview {
            margin-left:110px;
            border: 2px solid blue;
            margin top: 10px;
            margin bottom: 10px;
        }

        pre {
            background: #efefff;
            /* opacity: 0.8; */
            border: 0px solid black;
            width: 80%;
            margin-left: 20px;
            padding-left: 10px;
        }
    </style>

    <style media="only screen and (max-device-width: 768px)" type="text/css">
        .sidebar {
            position: inherit;
            width: inherit;
            margin: 0;
            padding: 25px;
        }

        .content {
            margin: 0;
            padding: 5px 25px;
            width: inherit;
        }
    </style>

    <script>
        var disqus_shortname = 'dkwbda';
        var disqus_title; // = "LONG_DATE";
        var disqus_identifier; // = "ISO_DATE";
        var disqus_category_id = "3249338";
        var disqus_url;

        var disqus_config = function () {
            this.language = "en";
        };

        function loadDisqus(source, identifier, url) {
            var disqus_thread = document.getElementById('disqus_thread');

            if (disqus_thread == null) {
                source.insertAdjacentHTML('beforeend', '<div id="disqus_thread"></div>');
                disqus_thread = document.getElementById('disqus_thread');
            }

            disqus_identifier = identifier.toString(); //set the identifier argument
            disqus_url = url.toString(); //set the permalink argument

            if (window.DISQUS) {
                // Move the thread placeholder to the new location
                source.parentNode.appendChild(disqus_thread);

                var parameters = {
                    reload: true,

                    config: function () {
                        this.page.identifier = disqus_identifier;
                        this.page.url = disqus_url;
                    }
                };

                DISQUS.reset(parameters);
            }
            else {
                var script_holder = (
                    document.getElementsByTagName('head')[0] ||
                    document.getElementsByTagName('body')[0]
                );

                //append the Disqus embed script to HTML
                var dsq = document.createElement('script');

                dsq.id = 'disqus_embed';
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';

                script_holder.appendChild(dsq);
            }
        }

        function raise_section(section_name) {
            d3
                .select(".main")
                .select("div:nth-of-type(2)")
                .selectAll("section")
                .style("display", "none")
            ;

            var section_obj = document.getElementById(section_name);

            loadDisqus(
                section_obj,
                section_obj.id,
                'http://damionw.github.io/' + section_name
//                 document.URL + '#!' + section_name
            );

            section_obj.style.display = "inline";
        }

        function init() {
            var sections = d3
                .select(".main")
                .select("div:nth-of-type(2)")
                .selectAll("section");

            var get_id = function(_selection) {
                return _selection.id;
            }

            var main_sections = sections.filter(":not(.blog-entry)")[0].map(get_id);
            var blog_sections = sections.filter(".blog-entry")[0].map(get_id);

            d3
                .select("#choices")
                .selectAll("li")
                .data(main_sections)
                .enter()
                    .append("li")
                    .attr("onclick", function(d) {return "raise_section('" + d + "');";})
                    .text(function(d) { return d;})
            ;

            d3
                .select("#archive")
                .selectAll("li")
                .data(blog_sections)
                .enter()
                    .append("li")
                    .attr("onclick", function(d) {return "raise_section('" + d + "');";})
                    .text(function(d) { return d;})
            ;

            if (blog_sections.length) {
                d3
                    .select("#choices")
                    .append("li")
                    .attr("onclick", function(d) {return "raise_section('" + blog_sections[0] + "');";})
                    .text("Blog")
                ;

                raise_section(blog_sections[0]);
            }
            else {
                raise_section("About");
            }
        }
    </script>
</head>
<body onload="init();">
<div class="sidebar">
    <header>
        Damion Wilson's Blog
    </header>
    <hr>
    <div class="buttonbar">
<a href="https://github.com/damionw">
    <svg width="16px" height="16px" viewBox="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
        <path d="M0.336871032,30 C0.336871032,13.4314567 13.5672313,0 29.8877097,0 C46.208188,0 59.4385483,13.4314567 59.4385483,30 C59.4385483,46.5685433 46.208188,60 29.8877097,60 C13.5672313,60 0.336871032,46.5685433 0.336871032,30 Z M0.336871032,30" id="Github" fill="#333333" sketch:type="MSShapeGroup"></path>
        <path d="M18.2184245,31.9355566 C19.6068506,34.4507902 22.2845295,36.0156764 26.8007287,36.4485173 C26.1561023,36.9365335 25.3817877,37.8630984 25.2749857,38.9342607 C24.4644348,39.4574749 22.8347506,39.62966 21.5674303,39.2310659 C19.7918469,38.6717023 19.1119377,35.1642642 16.4533306,35.6636959 C15.8773626,35.772144 15.9917933,36.1507609 16.489567,36.4722998 C17.3001179,36.9955141 18.0629894,37.6500075 18.6513541,39.04366 C19.1033554,40.113871 20.0531304,42.0259813 23.0569369,42.0259813 C24.2489236,42.0259813 25.0842679,41.8832865 25.0842679,41.8832865 C25.0842679,41.8832865 25.107154,44.6144649 25.107154,45.6761142 C25.107154,46.9004355 23.4507693,47.2457569 23.4507693,47.8346108 C23.4507693,48.067679 23.9990832,48.0895588 24.4396415,48.0895588 C25.3102685,48.0895588 27.1220883,47.3646693 27.1220883,46.0918317 C27.1220883,45.0806012 27.1382993,41.6806599 27.1382993,41.0860982 C27.1382993,39.785673 27.8372803,39.3737607 27.8372803,39.3737607 C27.8372803,39.3737607 27.924057,46.3153869 27.6704022,47.
2457569 C27.3728823,48.3397504 26.8360115,48.1846887 26.8360115,48.6727049 C26.8360115,49.3985458 29.0168704,48.8505978 29.7396911,47.2571725 C30.2984945,46.0166791 30.0543756,39.2072834 30.0543756,39.2072834 L30.650369,39.1949165 C30.650369,39.1949165 30.6837446,42.3123222 30.6637192,43.7373675 C30.6427402,45.2128317 30.5426134,47.0792797 31.4208692,47.9592309 C31.9977907,48.5376205 33.868733,49.5526562 33.868733,48.62514 C33.868733,48.0857536 32.8436245,47.6424485 32.8436245,46.1831564 L32.8436245,39.4688905 C33.6618042,39.4688905 33.5387911,41.6768547 33.5387911,41.6768547 L33.5988673,45.7788544 C33.5988673,45.7788544 33.4186389,47.2733446 35.2190156,47.8992991 C35.8541061,48.1209517 37.2139245,48.1808835 37.277815,47.8089257 C37.3417055,47.4360167 35.6405021,46.8814096 35.6252446,45.7236791 C35.6157088,45.0178155 35.6567131,44.6059032 35.6567131,41.5379651 C35.6567131,38.470027 35.2438089,37.336079 33.8048426,36.4323453 C38.2457082,35.9766732 40.9939527,34.880682 42.3337458,31.9450695 C42.4383619,31.
9484966 42.8791491,30.5737742 42.8219835,30.5742482 C43.1223642,29.4659853 43.2844744,28.1550957 43.3168964,26.6025764 C43.3092677,22.3930799 41.2895654,20.9042975 40.9014546,20.205093 C41.4736082,17.0182425 40.8060956,15.5675121 40.4961791,15.0699829 C39.3518719,14.6637784 36.5149435,16.1145088 34.9653608,17.1371548 C32.438349,16.3998984 27.0982486,16.4712458 25.0957109,17.3274146 C21.4005522,14.6875608 19.445694,15.0918628 19.445694,15.0918628 C19.445694,15.0918628 18.1821881,17.351197 19.1119377,20.6569598 C17.8961113,22.2028201 16.9902014,23.2968136 16.9902014,26.1963718 C16.9902014,27.8297516 17.1828264,29.2918976 17.6176632,30.5685404 C17.5643577,30.5684093 18.2008493,31.9359777 18.2184245,31.9355566 Z M18.2184245,31.9355566" id="Path" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>
        <path d="M59.4385483,30 C59.4385483,46.5685433 46.208188,60 29.8877097,60 C23.8348308,60 18.2069954,58.1525134 13.5216148,54.9827754 L47.3818361,5.81941103 C54.6937341,11.2806503 59.4385483,20.0777973 59.4385483,30 Z M59.4385483,30" id="reflec" fill-opacity="0.08" fill="#000000" sketch:type="MSShapeGroup"></path>
    </svg>
</a>
<a href="mailto:dkwbda@yahoo.com" subject="blog comment">
<svg width="16px" height="16px" viewBox="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
    <path d="M0.224580688,30 C0.224580688,13.4314567 13.454941,0 29.7754193,0 C46.0958976,0 59.3262579,13.4314567 59.3262579,30 C59.3262579,46.5685433 46.0958976,60 29.7754193,60 C13.454941,60 0.224580688,46.5685433 0.224580688,30 Z M0.224580688,30" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>
    <path d="M35.0384324,31.6384006 L47.2131148,40.5764264 L47.2131148,20 L35.0384324,31.6384006 Z M13.7704918,20 L13.7704918,40.5764264 L25.9449129,31.6371491 L13.7704918,20 Z M30.4918033,35.9844891 L27.5851037,33.2065217 L13.7704918,42 L47.2131148,42 L33.3981762,33.2065217 L30.4918033,35.9844891 Z M46.2098361,20 L14.7737705,20 L30.4918033,32.4549304 L46.2098361,20 Z M46.2098361,20" id="Shape" fill="#333333" sketch:type="MSShapeGroup"></path>
    <path d="M59.3262579,30 C59.3262579,46.5685433 46.0958976,60 29.7754193,60 C23.7225405,60 18.0947051,58.1525134 13.4093244,54.9827754 L47.2695458,5.81941103 C54.5814438,11.2806503 59.3262579,20.0777973 59.3262579,30 Z M59.3262579,30" id="reflec" fill-opacity="0.08" fill="#000000" sketch:type="MSShapeGroup"></path>
</svg>
</a>

<a href="http://www.linkedin.com/pub/damion-wilson/3/773/766">
<svg width="16px" height="16px" viewBox="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
    <path d="M0.449161376,30 C0.449161376,13.4314567 13.6795217,0 30,0 C46.3204783,0 59.5508386,13.4314567 59.5508386,30 C59.5508386,46.5685433 46.3204783,60 30,60 C13.6795217,60 0.449161376,46.5685433 0.449161376,30 Z M0.449161376,30" fill="#007BB6" sketch:type="MSShapeGroup"></path>
    <path d="M22.4680392,23.7098144 L15.7808366,23.7098144 L15.7808366,44.1369537 L22.4680392,44.1369537 L22.4680392,23.7098144 Z M22.4680392,23.7098144" id="Path" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>
    <path d="M22.9084753,17.3908761 C22.8650727,15.3880081 21.4562917,13.862504 19.1686418,13.862504 C16.8809918,13.862504 15.3854057,15.3880081 15.3854057,17.3908761 C15.3854057,19.3522579 16.836788,20.9216886 19.0818366,20.9216886 L19.1245714,20.9216886 C21.4562917,20.9216886 22.9084753,19.3522579 22.9084753,17.3908761 Z M22.9084753,17.3908761" id="Path" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>
    <path d="M46.5846502,32.4246563 C46.5846502,26.1503226 43.2856534,23.2301456 38.8851658,23.2301456 C35.3347011,23.2301456 33.7450983,25.2128128 32.8575489,26.6036896 L32.8575489,23.7103567 L26.1695449,23.7103567 C26.2576856,25.6271338 26.1695449,44.137496 26.1695449,44.137496 L32.8575489,44.137496 L32.8575489,32.7292961 C32.8575489,32.1187963 32.9009514,31.5097877 33.0777669,31.0726898 C33.5610713,29.8530458 34.6614937,28.5902885 36.5089747,28.5902885 C38.9297703,28.5902885 39.8974476,30.4634101 39.8974476,33.2084226 L39.8974476,44.1369537 L46.5843832,44.1369537 L46.5846502,32.4246563 Z M46.5846502,32.4246563" id="Path" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>
    <path d="M59.5508386,30 C59.5508386,46.5685433 46.3204783,60 30,60 C23.9471212,60 18.3192858,58.1525134 13.6339051,54.9827754 L47.4941264,5.81941103 C54.8060245,11.2806503 59.5508386,20.0777973 59.5508386,30 Z M59.5508386,30" id="reflec" fill-opacity="0.08" fill="#000000" sketch:type="MSShapeGroup"></path>
</svg>
</a>

</div>
    <hr>
    <ul class="nobullets" id="choices">
    </ul>

    <hr>
    Archives
    <ul class="nobullets" id="archive">
    </ul>
</div>

<div class="main">
    <div>
        <h1 class="blog-title">
            <a href="http://damionw.github.io/">
                Geek on a Rock
            </a>
        </h1>

        <h2 class="blog-description">
            Coding in Bermuda ... and other stuff
        </h2>
    </div>

    <div>
        <section id="About">
            <header class="post-header">
<h2 class="post-title">About Me</h2>
</header>
<p>
My name is Damion Wilson and I've been a programming enthusiast for a while now
(anyone else remember the Apple II ? Atari 800 ? Vic-20 ? I guess not).
</p>
<p>
I've been lucky to have been employed programming in the banking, telecoms, trading,
and reinsurance industries and even did some sysadmin/devops work too. Even so, I can't
help writing code all the time (someone should eventually stop me).
</p>
<p>
Right now, I'm in reinsurance working on risk systems with a group of really smart
characters, and have a wonderful wife and two daughters, which is about the best
anyone can hope for.
</p>
<p>
I won't bother to tell all the things I've written stuff in, but what I like to write
in these days are Python(Pandas, Numpy, Django), C++(Boost), C(yes, still), Erlang, and
SQL(PostgreSQL, SQL Server). I have a weakness for Network and Systems programming
which can be evidenced by the rather ancient
<a href="http://cipe-win32.sourceforge.net/">CIPE-Win32</a>
but I also have been known to do GUI work in perl with
evidenced by the similarly ancient
<a href="http://search.cpan.org/~dkwilson/Tk-DKW-0.03/">Tk-DKW</a>.
</p>
<p>
My more recent stuff will (eventually) appear <a href="https://github.com/damionw">here</a>
</p>
<p>
Other interests are cycling, <a href="http://www.sanshou.bm/">martial arts</a>, cabinet carpentry and gardening
</p>
        </section>

        <section id="Links">
            <header class="post-header">
<h2 class="post-title">Links</h2>
</header>

<ul class="nobullets linkformat">
    <li><a href="https://groups.google.com/forum/#!forum/open-bermuda">Open Bermuda: Promoting a community of open source and open data in Bermuda</a></li>
    <li><a href="http://bermuda.io/">Bermuda.io: Open Data and Analysis Community</a></li>
    <li><a href="https://github.com/damionw">My GitHub Repos</a></li>
    <li><a href="http://deonheyns.com/">Deon Heyns blog</a></li>
    <li><a href="http://bytesnbikes.blogspot.com/">John Gill's blog</a></li>
</ul>
        </section>

        <section id="2020-12-01" class="blog-entry">

<a class="jumpto" name="2020-12-01"></a>

<header class="post-header">
    <span class="post-meta">
        <time datetime="2020-12-01">
            December 01, 2020
        </time>
    </span>
    <h2 class="post-title">A Case for Modular Bash Applications</h2>
</header>

<header class="post-header">
    <h3>What were you thinking ???</h3>
</header>

<p>
As an old Unix developer (circa 1986), I've successfully written
and deployed mission critical applications and services using shell.
So, as a <i>proper</i> programming language, bash is even more adept
</p>

<p>
However, some of the drawbacks are difficult to ignore:

<ul>
<li>No Standard Library Concept</li>
<li>Arcane Syntax</li>
<li>Ambiguous Features</li>
<li>No Namespaces</li>
<li>Slow</li>

</ul>

Some of these concerns can be mitigated however...
</p>

<header class="post-header">
    <h3>File layout for a Bash Application</h3>
</header>

<p>
Historically, bash programs are single file affairs. Why? because there aren't
standardised expectations for deploying and importing application libraries.
</p>

<p>
Binary applications commonly deposit shareable objects in /usr/lib or /usr/local/lib.
Python package management, similarly, create and manage modules beneath /usr/local/lib/python-<version>.
Bash has no standard package management, but that doesn't mean we can't leverage standard library directories in
the same way
</p>

<header class="post-header">
    <h3>Flubber : A demo bash application</h3>
</header>

<p>
Let's call our test application flubber. Here's the on disk layout
</p>

<pre>
<code>
/usr
    /bin
        /flubber
    /lib
        /flubber-0.01
            /features

        /flubber
</code>
</pre>
<p>
/usr/bin/flubber is the program entry point. What does it do ?
</p>

<pre>
<code>
#!/usr/bin/env bash

# Locate the library path
binary_file="$(readlink -f "${BASH_SOURCE[0]}")"
binary_path="$(dirname "${binary_file}")"
binary_name="$(basename "${binary_file}")"
library_import_file="$(readlink -f "${path_path}/../lib/${binary_name}")"
</code>
</pre>
<p>
This preamble asserts that the library will be located relative to the binary, this time
in /usr/lib/flubber. Then, we import the library with
</p>

<pre>
<code>
. "${library_import_file}"
</code>
</pre>

<p>
This let's us divorce the binary from the library code. It also lets other entities, or
even an interactive session, import the library's namespace elements and functionality
directly. More on this later. For now, let's look at /usr/lib/flubber...
</p>

<pre>
<code>
#!/usr/bin/env bash

library_file="$(readlink -f "${BASH_SOURCE[0]}")"
library_path="$(dirname "${binary_file}")"
package_name="$(basename "${library_file}")"
</code>
</pre>

<p>
Similar file location behaviour as in the binary, but we're actually interested
in determining something else...
</p>

<pre>
<code>
export __FLUBBER_VERSION__="$(
    find "${library_path}/${package_name}"-[.0-9]* -maxdepth 0 -mindepth 0 -type d -printf "%f$n" |
    awk -F- '{print $NF;}' |
    sort -nr |
    head -1
)"
</code>
</pre>

<p>
... which is capturing the numbered subdirectories prefixed with the package name, in this case
there's only flubber-0.01. We then use that subdirectory to import the component modules.
</p>

<p>
There's only one: features.
</p>

<pre>
<code>
import_path="${local_path}/${package_name}-${__FLUBBER_VERSION__}"

. "${import_path}/features"
</code>
</pre>

<p>
After we import the components, for good measure, we refresh the namespace cache with hash -r
</p>

<pre>
<code>
hash -r
</code>
</pre>

<p>
The file /usr/local/lib/flubber-0.01/features provides functions specific to flubber features
</p>

<pre>
<code>
#!/usr/bin/env bash

flubber::features::construct() {
    echo "FLUBBER construction"
}
</code>
</pre>

<p>
We're only defining one function in this module, using namespace naming semantics
to forego collisions with other libraries or modules.
<br>
Bash, of course, doesn't care that we're using colons in its function names.
The point is, flubber will be able to call flubber::features::construct and we'll
understand what the function is and where its coming from
</p>

<header class="post-header">
    <h3>Using Flubber</h3>
</header>

<p>
Now we can finish off /usr/bin/flubber. We won't get into getopt based command line
options handling just yet (another post will cover that). However, we will accept a
single command line option
</p>

<pre>
<code>
case "$1" in
    --lib)
        echo "${library_import_file}"
        shift
        exit 0
        ;;
esac
</code>
</pre>

<p>
So, if we run flubber, we'll get the library import entry point
</p>
<pre>
<code>
$ flubber --lib

/usr/lib/flubber
</code>
</pre>

<p>
We can now import the namespace from the command line
</p>
<pre>
<code>
$ . $(flubber --lib)
$ flubber::features::construct

FLUBBER construction
</code>
</pre>

<p>
We can also endow the flubber application with the same capability, essentially
'exporting' the internal behaviour via the user interface. If we rewrite the case
statement to add another option --doit
</p>

<pre>
<code>
case "$1" in
    --lib)
        echo "${library_import_file}"
        shift
        exit 0
        ;;

    --doit)
        flubber::features::construct
        shift
        exit 0
        ;;
esac
</code>
</pre>

<p>
We can run it like this
</p>

<pre>
<code>
$ flubber --doit

FLUBBER construction
</code>
</pre>

<header class="post-header">
    <h3>What Next?</h3>
</header>

<ul>
<li>
<p>
As mentioned, there's no getopt parameter handling here, but there is a pattern
(and a library) to handle that.
</p>
</li>

<li>
<p>
Adding features to flubber now consists of changing or adding files in /usr/lib/flubber-0.01
New versions should be exposed by renaming to or adding /usr/lib/flubber-0.0x
</p>
</li>

<li>
<p>
Makefiles for existing applications can be augmented to place components into
the appropriate directory layout and monolithic code blocks can then be reliably
refactored into discrete components.
</p>
</li>
</ul>

<p>
A representative example of this pattern, which is also the library providing getopt
integration can be found here here: <a href=https://github.com/damionw/optionslib>https://github.com/damionw/optionslib</a>
</p>
</section>
<section id="2018-03-25" class="blog-entry">

<a class="jumpto" name="2018-03-25"></a>

<header class="post-header">
    <span class="post-meta">
        <time datetime="2018-03-25">
            March 25, 2018
        </time>
    </span>
    <h2 class="post-title">Shell Function keyword arguments</h2>
</header>

<header class="post-header">
    <h3>The Problem</h3>
</header>

<p>
    For those of you who might be unfamilar, BASH, or Bourne Again Shell, really is a complete
    programming language, replete with every facility you might want.
</p>
<p>
However, there are features it infuriatingly lacks that one might have experienced in other languages,
such as Erlang, Perl or Python
</p>
<p>
Having worked in Python constantly since 2008, I'm particular to amenities offered there, especially
when I'm using Bash as 'glue' to string together tools that are themselves written in Python.
</p>
<p>
To this end, one such feature is the ability in Python to specify function parameters either by keyword
or by position.
</p>
<p>
And, in a moment of heightened irritation, I had to have it...
</p>
<header class="post-header">
    <h3>What it looks like</h3>
</header>

<p>
Here's a python function with two parameters:
</p>
<pre>
<code>
def myfunc(one, two):
    print one
    print two
</code>
</pre>
<p>
We can call it many ways:
</p>
<pre>
<code>
myfunc(one=1, two=2)
myfunc(1, 2)
myfunc(1, two=2)
</code>
</pre>
<p>
Each invocation ensures that, within the body of myfunc(), variables one and two
are given the respective values 1 and 2
</p>

<header class="post-header">
    <h3>BASH Use Case</h3>
</header>
<p>
So, what would this look like in BASH?
</p>
<p>
We can't rely on BASH itself, which doesn't offer keyword parameters on its own. All it
knows about are positional parameters. However, they're all strings, so what if we passed
parameters that looked like this:
</p>
<pre>
<code>
myfunc "one=1" "two=2" 3 4
</code>
</pre>
<p>
Ok, so within the function, we have an arrangement where a positional string value could be in
a special form, where something like <identifier>= might be prepended
</p>
<pre>
<code>
$1="one=1"
$2="two=2"
$3="3"
$4="4"
</code>
</pre>
<p>
After that, we'd need to preprocess the argument list and evaluate all the values and populate
a keyword hash table, supported in Bash >= 4.0 (see <a ref="https://stackoverflow.com/questions/1494178/how-to-define-hash-tables-in-bash"></a>)
</p>
<pre>
<code>
eval "$(argument_formatter "$@")"
</code>
</pre>
<p>
Which would populate a hash table named kwargs and a positional array named args (internally managed in python)
</p>
<pre>
<code>
$ echo ${kwargs["one"]}

1

$ echo ${kwargs["two"]}

2

$ echo ${args[0]}

3

$ echo ${args[1]}

4
</code>
</pre>
<p>
Determining where/how to use mixed positional and keyword interpretations
</p>
<pre>
<code>
myfunc one=1 2
</code>
</pre>
<p>
Extracting the values could look like so...
</p>
<pre>
<code>
$ one=${kwargs["one"]:-${args[0]}}
$ two=${kwargs["two"]:-${args[1]}}
$ echo $one

1

$ echo $two

2
</code>
</pre>
<p>
...ensuring the kwarg is preferred, but the positional argument is used as the default
</p>
<header class="post-header">
    <h3>Implementation</h3>
</header>
<p>
But, how do we implement this feature. Glad you asked. Here, we're calling our function
this
</p>
<pre>
<code>
argument_formatter() {
...
}
</code>
</pre>
<p>
Inside, we first create separate arrays to hold the keyword and the
positional arguments as we parse them from the parameter list.
Note the difference in declaration styles for the associative vs indexed arrays.
</p>
<pre>
<code>
    local -A _keyword_args=()
    local -a _positional_args=()
</code>
</pre>

<p>
Then, let's loop through them, looking for entries of the form &ltidentifier&gt=&ltvalue&gt. Those'll
be the keyword args, anything else is positional. We have to split the keywords from their values
so we can store them in the associative array
</p>

<pre>
<code>
    for _parameter in "$@"
    do
        if (echo "${_parameter}" | grep -q '^[[:alpha:]][[:alnum:]]*[=]')
        then
            _key="$(echo "${_parameter}" | sed -e 's/=.*$//g')"
            _value="$(echo "${_parameter}" | sed -e 's/^[^=]*=//g')"
            _keyword_args["${_key}"]="${_value}"
        else
            _positional_args[${#_positional_args[@]}]="${_parameter}"
        fi
    done
</code>
</pre>

<p>
Then, since we're using eval, we just print out the bash source
required to create the kwargs in the target scope
</p>

<pre>
<code>
    echo -n "local -A kwargs=("
    for _key in "${!_keyword_args[@]}"
    do
        echo -n " [$"${_key}$"]=$"$(echo "${_keyword_args["${_key}"]}" | sed -e 's/$"/$$$"/g')$""
    done
    echo " )"
</code>
</pre>

<p>
And, likewise, the source required to create the positional args in the target scope
</p>

<pre>
<code>
    echo -n "local -a args=("
    for _value in "${_positional_args[@]}"
    do
        echo -n " $"$(echo "${_value}" | sed -e 's/$"/$$$"/g')$""
    done
    echo " )"
</code>
</pre>

<p>
That's it! Once eval'ed, the calling function will have the kwargs and args arrays
defined locally
</p>

<p>
You can see the full implementation here: <a href=https://github.com/damionw/bashLib/blob/master/src/lib/bashLib-0.12/arguments>https://github.com/damionw/bashLib/blob/master/src/lib/bashLib-0.12/arguments</a>
or clone <a href=https://github.com/damionw/bashLib>https://github.com/damionw/bashLib</a> and try it out from there.
</p>
<p>
I hope that was informative !
</p>
</section><section id="2016-03-11" class="blog-entry">

<a class="jumpto" name="2016-03-11"></a>

<header class="post-header">
    <span class="post-meta">
        <time datetime="2016-03-11">
            March 11, 2016
        </time>
    </span>
    <h2 class="post-title">Reference Counted Process Group Supervision</h2>
</header>

<header class="post-header">
    <h3>The Provocation</h3>
</header>

<p>
Some months ago, in a flurry of frustration provoked coding, I implemented my
own email client. At some point, it'll make a blog post but, for now, suffice
it to say that my once torrid love affair with Kmail from KDE3 has ended with
the advent of KDE4. As an aside, it's sad that software projects can and do
reach perfection and then pass it by in their quests for relevance
</p>

<header class="post-header">
    <h3>Email Services</h3>
</header>

<p>
In the details of writing an email client are essentially 4 elements, which can
all be represented as separate services, though in mass market clients, they're
strangely all bundled into a single executable, binding them unnecessarily.
</p>

<p>
<table class="tableview">
<tr><td>Retrieval</td></tr>
<tr><td>Dispatching</td></tr>
<tr><td>Indexing</td></tr>
<tr><td>Viewing</td></tr>
</table>
</p>

<p>
In my case, I merged the Retrieval and Indexing into a single service, but I'm sure you get
the picture
</p>

<p>
The nature of email clients are that, typically, the user will start the email program just
after login, which is when any queued messages are sent, new messages are received, and the
UI is displayed with whatever viewing preferences the user last selected.
</p>

<p>
In my case, each separate service needed to be started, too, but with a difference. Since
the UI is only needed for me to view email, I don't need to start the UI then (more on that
later), but email collection and dispatching should start happening independently.
</p>

<p>
With the pattern that emerged, it became clear that email collection and dispatch were services
<i>linked to my login</i>. But which login ? I'm on linux where I could login via ssh and
conceivably want my email to start working. The keyboard and screen interface is only one
part of the user experience
</p>

<p>
So, it seemed that I needed a service 'group', consisting of three services:

<table class="tableview">
<tr><td>email_send</td></tr>
<tr><td>email_retrieval</td></tr>
<tr><td>webmail_service</td></tr>
</table>
</p>

<p>
The webmail service materialised after I decided not to use a Qt standalone UI and, instead,
implemented the client using a browser interface. The services are not interdependent in this
case, but they are connected by the common file structure and that they are subservient to
at <i>least one</i> active user login session.
</p>

<header class="post-header">
    <h3>Supervised Processes with Reference Counting</h3>
</header>

<p>
After this set of requirements became clear, I implemented a Bash script that, when invoked,
would test for the presence of a process group supervisor, which was responsible for ensuring
that the three services were alive and maintaining the list of dependent processes. If the
supervisor were not present, it would be started and then it would launch the three services.
</p>

<p>
The script would also inform the supervisor about the process id (PID) of the shell that invoked
it, adding it to the list of dependents. Subsequently, the running supervisor would delete
PID's from the list as the processes disappeared or when explicitly commanded to do so.
</p>

<p>
Once the list of dependents was empty, the supervisor would shutdown, after stopping its services
</p>

<p>
After running the suite for several months, it became apparent that this was the arrangement I'd
been missing the whole time! Indeed, I was provoked to add on other services, such as a notifier that
fades the incoming subject lines in and out on the screen independently of an active email client.
</p>

<header class="post-header">
    <h3>Chaining</h3>
</header>

<p>
Soon, it became obvious that what was needed was a general purpose tool, that would maintain arbitrary
process groups, utilising the same approach. So, after another flurry of viscious coding, I produced such
a tool which can be seen <a href="https://github.com/damionw/process-groups">here</a>
</p>

<p>
Normally, I'd show the code to implement this, but that's going to be a turnoff unless you're hot for Bash
code. No, what's more interesting is what's possible with reference counted process groups.
</p>

<p>
The process groups can be chained. Let's imagine that for a moment:
<br>
Each of the managed services in a process group can run the same Bash script and express interest in another
named group of services. Doing so introduces a managed group dependency, ensuring that, as long as the first
group is running, the other group will be running too.
</p>

<p>
And, as it turns out, this is exactly what happens when an init system runs, or supervisord, or any of the
other process supervision/startup frameworks. Except, this approach differs in that it does support a
dendritic dependency graph but does not attempt to do so from the top down. And, if any group is explicitly
stopped by pruning the dependencies, all of the groups that list it as a dependent will be stopped if that
is their only dependent.
describe the dependency
</p>

<p>
I'll stop there, before I start showing you any Bash, but I encourage you to play with the tool and explore
what can be done with these kinds of process groups.
</p>

</section><section id="2016-02-24" class="blog-entry">

<a class="jumpto" name="2016-02-24"></a>

<header class="post-header">
    <span class="post-meta">
        <time datetime="2016-02-24">
            February 24, 2016
        </time>
    </span>

    <h2 class="post-title">Is Rational Thought Dying ?</h2>
</header>

<p>
I've observed a troubling theme appearing with increasing frequency
in modern discourse. Available news sources and personal interactions
all seem to indicate, least anecdotally,that consideration of rationality
has become something of an anachronism.
</p>

<p>
Ok, ok. Maybe that's just a bit too doom and gloom for a personal blog, but hear me out.
</p>

<p>
Historically, great effort was put into fitting preordained conclusions into at least
a facade of reasonable explanation,lending the subsequent decision making seem driven
by confirmable evidence. Debate skills were in high demand for such work, whether
for national or local politics, business, even science and engineering. In this regime,
dissenters at least had a chance for provoking change since, if the evidence could be
demonstrated as being incorrect, and hence the conclusions, then reversals could be forced.
Not always, but often enough. Famous examples of this kind of change are evident in fights
for voting rights and civil actions against misbehaving corporations.
</p>

<p>
But now...
</p>

<p>
Now we see that the occurrences of such manoeuvring are disappearing. The new doctrine is
to state,one's goals from a position of authority or power. This effort does seem to (still)
be accompanied by some attempt at providing a reason or a motivation for the subsequent actions,
but the explanations are less substantial, less well built to resist challenge. Indeed, when
challenges are made, the arguments are defended weakly or are abandoned, leaving
the original behaviour in place with only the provocateur's authority to support it. Examples of
this are found in the Global Warming 'debates',and denials of marriage rights.
</p>

<p>
Now, it's important to recognize that the same manifest behaviour of the powerful will not
be limited by 'the people' so much that it will be limited by the self policing of the powerful
in an attempt to appear to be rational. The 'powerful' in this context simply refers to those
with the ability to control policy outcomes that affect people's lives other than their own.
<br>
This could refer to people like judges, business owners, politicians, and even heads of criminal
enterprise. But it could also mean climate scientists or biochemists employed in perverse circumstances.
Of course, any one of us is susceptible to the twin sins of vanity and lust.
</p>

<p>
So, it appears that what we're <i>actually</i> losing is the desire of people in positions of
control to <i>appear</i> to be rationally driven. Is this really a bad thing? Given that people
will ultimately do what they want anyway, are we really losing anything by dispensing with
the facade?
</p>

<p>
Well, I certainly think so, and here's why:
<br><br>
When someone attempts to enact policy, any attempt to fit that policy into a framework of rationality
<bold>will change that policy</bold>. This is inescapable. The narrative acts as a form of logical cage
that will illuminate any part of the policy that pokes out through the wires. Any actor disinterested
in allowing that form of scrutiny, will address those weaknesses. Though changing the narrative is an
option, that's harder since it needs to be verifiable to work.
/p>

<p>
By now, your wondering why, in this anecdotally supported thesis of mine, have we dispensed with this
particular form of delusion?
<br<br>
In a word, inattention
</p>

<p>
The evidence abounds that, in general, entire national populations are less engaged in the aspects of
their own governance and economic health.
</p>

<p>
This is a terrifying prospect, and I really hope its not true, but I can't escape that conclusion
hard as I might try. In essence, people have become consumed more and more with basic needs and
are less inclined or even able to hold those in power accountable using the knowledge available to them.
Even when there's more information available to them than at any time in human history.
</p>

<p>
I don't have a recipe for correcting for this kind of circumstance. Indeed, the perversion is obvious. There's
no reason that anyone previously under scrutiny and having escaped that scrutiny, would invite it back. Especially
so, that person is likely to do everything possible to prevent said scrutiny from reappearing. And, its just
so easy to give those that would otherwise be interested in your behaviour something else to trouble themselves
with...
</p>

<p>
Of course, the savvy will correctly note that rational decision making as a concept is a recent thing (hey, they didn't
call them the 'dark ages' for nothing). And the romans themselves only had rules for those who weren't powerful enough to break them.
Furthermore, it's only pertinent in functioning democracies. But that's just the thing. Democracies have been making the
case that this form of applied logic is the best thing ever for centuries now. Progress in that context has always
been toward making this form of thinking more prevalent. It worked for science, right?
</p>

<p>
Unfortunately for us, though, the big problems can only be solved when we come together on them. And we can't do that unless
we can first agree on what's true. And that means talking sensibly about things.
</p>

<p>
Of course these opinions are only my own, and they're, of course, really just opinions :-)
<p>
</section><section id="2015-09-24" class="blog-entry">

<a class="jumpto" name="2015-09-24"></a>

<header class="post-header">
    <span class="post-meta">
        <time datetime="2015-09-24">
            September 24, 2015
        </time>
    </span>

    <h2 class="post-title">Python Object Proxying</h2>
</header>

            <p>
I stumbled upon this <a href="http://code.activestate.com/recipes/496741-object-proxying/">recipe</a>
and couldn't resist applying it to a common problem: converting linear computations into
parallel tasks with asynchronous result delivery.
            </p>
            <p>
But, enough about that for a while. What we're really here for is a simple implementation and use case
for this delectable technique
            </p>
            <p>
This time, we'll dive right into the implementation. Here is the basic class, without any augmentation
<pre>
<code>
class BasicObjectProxy(object):
    __slots__ = ["_obj", "__weakref__"]

    def __init__(self, obj=None):
        object.__setattr__(self, "_obj", obj)

    #
    # proxying (special cases)
    #
    def __getattribute__(self, name):
        return getattr(object.__getattribute__(self, "_obj"), name)

    def __delattr__(self, name):
        delattr(object.__getattribute__(self, "_obj"), name)

    def __setattr__(self, name, value):
        setattr(object.__getattribute__(self, "_obj"), name, value)

    def __nonzero__(self):
        return bool(object.__getattribute__(self, "_obj"))

    def __str__(self):
        return str(object.__getattribute__(self, "_obj"))

    def __unicode__(self):
        return unicode(object.__getattribute__(self, "_obj"))

    def __repr__(self):
        return repr(object.__getattribute__(self, "_obj"))

    def _proxy_synchronise_(self):
        pass

    @classmethod
    def _create_class_proxy(cls, theclass):
        """creates a proxy for the given class"""

        def make_method(name):
            def method(self, *args, **kw):
                return getattr(object.__getattribute__(self, "_obj"), name)(*args, **kw)

            return method

        _proxied_accessor_methods = [
            '__abs__', '__add__', '__and__', '__call__', '__cmp__', '__coerce__',
            '__contains__', '__delitem__', '__delslice__', '__div__', '__divmod__',
            '__eq__', '__float__', '__floordiv__', '__ge__', '__getitem__',
            '__getslice__', '__gt__', '__hash__', '__hex__', '__iadd__', '__iand__',
            '__idiv__', '__idivmod__', '__ifloordiv__', '__ilshift__', '__imod__',
            '__imul__', '__int__', '__invert__', '__ior__', '__ipow__', '__irshift__',
            '__isub__', '__iter__', '__itruediv__', '__ixor__', '__le__', '__len__',
            '__long__', '__lshift__', '__lt__', '__mod__', '__mul__', '__ne__',
            '__neg__', '__oct__', '__or__', '__pos__', '__pow__', '__radd__',
            '__rand__', '__rdiv__', '__rdivmod__', '__reduce__', '__reduce_ex__',
            '__repr__', '__reversed__', '__rfloordiv__', '__rlshift__', '__rmod__',
            '__rmul__', '__ror__', '__rpow__', '__rrshift__', '__rshift__', '__rsub__',
            '__rtruediv__', '__rxor__', '__setitem__', '__setslice__', '__sub__',
            '__truediv__', '__xor__', 'next',
        ]

        return type(
            "%s(%s)" % (cls.__name__, theclass.__name__),
            (cls,),
            {
                _key: make_method(_key)
                for _key
                in _proxied_accessor_methods
                if hasattr(theclass, _key) and not hasattr(cls, _key)
            }
        )

    @classmethod
    def __new__(cls, obj, *args, **kwargs):
        proxied_type = obj.__class__

        try:
            cache = cls.__dict__["_class_proxy_cache"]
        except KeyError:
            cls._class_proxy_cache = cache = {}
        try:
            synthesized_class = cache[proxied_type]
        except KeyError:
            cache[proxied_type] = synthesized_class = cls._create_class_proxy(proxied_type)

        return object.__new__(synthesized_class)
</code>
</pre>
</p>
<p>
The entire trickery for BasicObjectProxy is contained in the overloaded __new__() and the class method _create_class_proxy()
</p>
<p>
new() uses the wrapped object type and calls _create_class_proxy() to produce a
new type that is built specifically to masquerade as the original type.
</p>
<p>
The artificial type (possibly cached) is used to
instantiate a new object, which is returned from the
'constructor'.
</p>
<p>
The wrapped object is then passed to __init__() where it is captured to provide
the underlying value for all of the proxy object's accessor methods.
</p>
<p>
_create_class_proxy() Iterates over a static list of possible attribute names,and
creates wrapper methods to implement each call that the wrapped type supports.
<br>
In this case, the wrapper methods jus return the underlying object, so the proxy
appears to be no different than the original object
</p>
<p>
So, now, we have a proxy class that can be used like so:
<pre>
<code>
>>> value = BasicObjectProxy(22)

>>> print value

22

>>> print type(value)

&lt;class '__main__.BasicObjectProxy(int)'&gt;

>>> print value + 11

33
</code>
</pre>
Not bad at all, but we want more...
</p>
<p>
What we <i>really</i> want is to intercept each accessor call, and substitute our own
sentinel before it.
</p>
<p>
To accomplish that, we have to do some work:
<pre>
<code>
class BasicObjectProxy(object):
    __slots__ = ["_obj", "__weakref__"]

    def __init__(self, obj=None):
        object.__setattr__(self, "_obj", obj)

    #
    # proxying (special cases)
    #
    def __getattribute__(self, name):
        object.__getattribute__(self, "_proxy_synchronise_")()
        return getattr(object.__getattribute__(self, "_obj"), name)

    def __delattr__(self, name):
        object.__getattribute__(self, "_proxy_synchronise_")()
        delattr(object.__getattribute__(self, "_obj"), name)

    def __setattr__(self, name, value):
        object.__getattribute__(self, "_proxy_synchronise_")()
        setattr(object.__getattribute__(self, "_obj"), name, value)

    def __nonzero__(self):
        object.__getattribute__(self, "_proxy_synchronise_")()
        return bool(object.__getattribute__(self, "_obj"))

    def __str__(self):
        object.__getattribute__(self, "_proxy_synchronise_")()
        return str(object.__getattribute__(self, "_obj"))

    def __unicode__(self):
        object.__getattribute__(self, "_proxy_synchronise_")()
        return unicode(object.__getattribute__(self, "_obj"))

    def __repr__(self):
        object.__getattribute__(self, "_proxy_synchronise_")()
        return repr(object.__getattribute__(self, "_obj"))

    def _proxy_synchronise_(self):
        pass

    @classmethod
    def _create_class_proxy(cls, theclass):
        """creates a proxy for the given class"""

        def make_method(name):
            def method(self, *args, **kw):
                object.__getattribute__(self, "_proxy_synchronise_")()
                return getattr(object.__getattribute__(self, "_obj"), name)(*args, **kw)

            return method

        _proxied_accessor_methods = [
            '__abs__', '__add__', '__and__', '__call__', '__cmp__', '__coerce__',
            '__contains__', '__delitem__', '__delslice__', '__div__', '__divmod__',
            '__eq__', '__float__', '__floordiv__', '__ge__', '__getitem__',
            '__getslice__', '__gt__', '__hash__', '__hex__', '__iadd__', '__iand__',
            '__idiv__', '__idivmod__', '__ifloordiv__', '__ilshift__', '__imod__',
            '__imul__', '__int__', '__invert__', '__ior__', '__ipow__', '__irshift__',
            '__isub__', '__iter__', '__itruediv__', '__ixor__', '__le__', '__len__',
            '__long__', '__lshift__', '__lt__', '__mod__', '__mul__', '__ne__',
            '__neg__', '__oct__', '__or__', '__pos__', '__pow__', '__radd__',
            '__rand__', '__rdiv__', '__rdivmod__', '__reduce__', '__reduce_ex__',
            '__repr__', '__reversed__', '__rfloordiv__', '__rlshift__', '__rmod__',
            '__rmul__', '__ror__', '__rpow__', '__rrshift__', '__rshift__', '__rsub__',
            '__rtruediv__', '__rxor__', '__setitem__', '__setslice__', '__sub__',
            '__truediv__', '__xor__', 'next',
        ]

        return type(
            "%s(%s)" % (cls.__name__, theclass.__name__),
            (cls,),
            {
                _key: make_method(_key)
                for _key
                in _proxied_accessor_methods
                if hasattr(theclass, _key) and not hasattr(cls, _key)
            }
        )

    @classmethod
    def _allocator(cls, proxied_type):
        try:
            cache = cls.__dict__["_class_proxy_cache"]
        except KeyError:
            cls._class_proxy_cache = cache = {}
        try:
            synthesized_class = cache[proxied_type]
        except KeyError:
            cache[proxied_type] = synthesized_class = cls._create_class_proxy(proxied_type)

        return object.__new__(synthesized_class)

    def __new__(cls, obj, *args, **kwargs):
        return cls._allocator(obj.__class__)
</code>
</pre>
</p>
<p>
Not too much has changed.
</p>
<p>
First, we instituted a call to a method named _proxy_synchronise_()
whenever one of the accessor methods is called.
</p>
<p>
Because we can't trust the object's symbol table anymore, we have to call object.__getattribute__()
every time we want a 'real' proxy object attribute.
</p>
<p>
In this class, we don't bother endow _proxy_synchronise_() with any functionality, since we
aim to subclass from it
</p>
<p>
We've also separated the __new__() from the wrapper class synthesis, which is now held
in class method _allocator()
</p>
<p>
So, with the new base class implementing the 'guts' of the proxying work, we can do anything
we want in a derived class...
<pre>
<code>
def ProxyObjectFactory(proxied_type, value_callback):
    class _Internal(BasicObjectProxy):
        def __new__(cls, *args, **kwargs):
            return cls._allocator(proxied_type)

        def __init__(self, initial_value):
            super(_Internal, self).__init__()

            if type(initial_value) == proxied_type:
                object.__setattr__(self, "_obj", initial_value)

        def _proxy_synchronise_(self):
            previous_value = object.__getattribute__(self, "_obj")
            object.__setattr__(self, "_obj", value_callback(previous_value))

    return _Internal
</code>
</pre>
Of course, we're doing more than just subclassing, but to what end ?
</p>
<p>
Well, we want to be able to create classes which wrap functions and then use
those classes to create any number of objects, using the same underlying function
<br>
To that end, the ProxyObjectFactory needs a type to masquerade and a function
which it then uses instead of getting the target type <i>and</i> the underlying
value from the wrapped object used in the original implementation.
</p>
<p>
As we can see, _proxy_synchronise_() is overloaded to fetch a value using the
provided callback method. In this case,the previously held wrapped value is passed
into it. That new value is then used to replace the wrapped value
</p>
<p>
Now we can synthesize a new wrapper type...
<pre>
<code>
>>> IntegerFunctionProxy = ProxyObjectFactory(int, lambda previous: previous * 2)
</code>
</pre>
implementing the interface for the int type and a function to multiply the previous
value by 2.
<br>
We make a wrapped instance this way, storing the initial value 1...
<pre>
<code>
>>> value = IntegerFunctionProxy(1)
</code>
</pre>
We can probe the proxy's values, which continue to double per the underlying function
<pre>
<code>
>>> print value

2

>>> print value

4

>>> print value

8

>>> print value + 7

23
</code>
</pre>
I think you get the idea
</p>
<p>
The callback in this case could be any function that takes and int and returns
an int.
</p>
<p>
One can already see that using a function to initiate an asynchronous request
and letting the proxy object marshall the return value could be trivial...
<br>
...well, almost trivial
</p>
<p>
I hope that was entertaining. Until next time ...
</p>
</section><section id="2015-01-18" class="blog-entry">

<a class="jumpto" name="2015-01-18"></a>

<header class="post-header">
    <span class="post-meta">
        <time datetime="2015-01-18">
            January 18, 2015
        </time>
    </span>

    <h2 class="post-title">Python Decorator Fun #2 : Prototyped Functions</h2>
</header>

            <p>
Exposure to Erlang, as is common with any developer with multi language experience,
has caused me to wish for similar features that are otherwise absent from Python
            </p>
            <p>
But some are not so difficult to implement, and one of these is Erlang's function
signatures.
            </p>
            <p>
In short, Erlang functions are differentiated by the parameter types and their order,
like C++ for instance, but also can be differentiated by the values that some or all
of the parameters may have.
            </p>
            <p>
This is really cool, because it takes out a lot of value checking and comparisons in
what should otherwise be a 'clean' representation of the problem's solution. Indeed,
this is one of the goals of functional programming itself, which Erlang represents
and a metaphor which Python supports
            </p>
            <p>
Here is a simple Erlang case
<pre>
<code>
start_registered(ModuleName) ->
    start_registered(ModuleName, []).

start_registered(ModuleName, Arguments) ->
    start_registered(ModuleName, ModuleName, Arguments).

start_registered(RegisterName, ModuleName, Arguments) ->
    {ok, Pid} = start_link(ModuleName, Arguments),
    register(RegisterName, Pid),
    {ok, Pid}.
</code>
</pre>

We won't get into the weird Erlang syntax (for Pythonistas) but we are defining three
forms of the same function, start_registered.
</p><p>
<pre>
<code>
start_registered(ModuleName) ->
    start_registered(ModuleName, []).
</code>
</pre>
This form takes a single module name and calls the same function with that module
name followed by an empty parameter list
</p><p>
<pre>
<code>
start_registered(ModuleName, Arguments) ->
    start_registered(ModuleName, ModuleName, Arguments).
</code>
</pre>
This takes a module name and list of arguments, calling itself using the same module
name to register as a task, then the module name and the parameter list
</p><p>
</p><p>
<pre>
<code>
start_registered(ModuleName, Arguments) ->
    start_registered(ModuleName, ModuleName, Arguments).
</code>
</pre>
And this form has a name to register the task as its first parameter, the module name
followed by the list of arguments.
</p><p>
This kind of use saves having to define a single function that has to parse the intent
of the caller on whether to use defaults or not.
</p><p>
What's not shown is the ability for Erlang to also employ value checking on any of the
function parameters, called guards.
</p><p>
But Python has no strict typing and function parameters are really just managed as a list
of names with no sign of intent other than what names are used.
<pre>
<code>
def myfunction(name, address):
    pass
</code>
</pre>
</p><p>
What can we infer about the name and address parameters ? Nothing really, because we
can (obviously) call it this way...
<pre>
<code>
myfunction(0.2, AutomobileClass(None))
</code>
</pre>
... with no implications or penalties. It's up to myfunction to dynamically determine
if the parameters are correct in context

Of course, the fluid type handling of dynamic languages like Python are desired attributes
but, it's still nice to be able to have such features when you want them
</p>
<p>
What would this feature look like in Python ?

Since we can't really justify modifying the language, and this is a decorators tutorial,
we can try it with decorator logic !
<pre>
<code>
@prototype(one=int, two=int)
def myfunction(one=1, two=0):
    print "myfunction(int, int)", one, two

@prototype(one=(int, {1,2,3}))
def myfunction(one):
    print "myfunction(int=[1,2,3])", one

@prototype(one=int)
def myfunction(one):
    print "myfunction(int)", one
</code>
</pre>

We have three forms of myfunction(). One which takes two integers, named one and two.
The next takes a single integer named one, which can have values 1, 2, or 3. And the last
which takes a single integer of any value.
</p>
<p>
Calling these would have this effect
<pre>
<code>
>>> myfunction(one=10, two=7)

myfunction(int, int) 10 7

>>> myfunction(one=2)

myfunction(int=[1,2,3]) 2

>>> myfunction(one=99)

myfunction(int) 99
</code>
</pre>
</p>

<p>
Interested in seeing how such a thing might be implemented ? I thought so
</p>
<p>
We import some required modules
<pre>
<code>
from inspect import getargspec
from collections import OrderedDict
</code>
</pre>
We need getargspec() to interrogate the function parameters and
OrderedDict because the function parameter order is significant when
applying the type signature
</p>

<p>
We're implementing this decorator as a class because (1) we use the class
namespace to store a persistent function registry and (2) we use instantiated
objects to store the function's signature (temporarily)
<pre>
<code>
class prototype(object):
    _registry = {}

    def __init__(self, **prototype):
        self._prototype = prototype
</code>
</pre>
Each call to prototype(...) instantiates a new prototype object
</p>
<p>
This method lets us get a dictionary strictly mapping parameter names and their types
<pre>
<code>
    @staticmethod
    def get_type_spec(prototype):
        for _key, _type in prototype.iteritems():
            if type(_type) == type:
                yield _key, _type
            elif type(_type) == tuple:
                yield _key, _type[0]
            else:
                raise Exception("Type specification '%s' must be either a single type or a tuple" % (_key))
</code>
</pre>
</p>
<p>
This method lets us get a dictionary strictly mapping parameter names and the set of
permissible values
<pre>
<code>
    @staticmethod
    def get_value_spec(prototype):
        for _key, _type in prototype.iteritems():
            if type(_type) == type:
                yield _key, None
            else:
                yield _key, _type[1]
</code>
</pre>
</p><p>
Since we're using an object to implement the function decoration, we have to handle
the call with the function object as a parameter.
<pre>
<code>
    def __call__(self, fn):
</code>
</pre>
First, we make sure that the class function registry gets an entry for our function's
name
<pre>
<code>
        collection = self._registry.setdefault(fn.__name__, [])
</code>
</pre>
Then we craft a function definition recording the function object, its parameter
list, its type map and its permissible value map
<pre>
<code>
        signature_definition = [
            fn,
            getargspec(fn),
            dict(self.get_type_spec(self._prototype)),
            dict(self.get_value_spec(self._prototype)),
        ]
</code>
</pre>
And then record it in the collection for this function name
<pre>
<code>
        collection.append(signature_definition)
</code>
</pre>
Finally, we return a lambda that captures the function's name and will
call our static handler method with it.
This is what gets recorded as the decorated function.
<pre>
<code>
        return lambda *args, **kwargs: self.handler(fn.__name__, args, kwargs)
</code>
</pre>
</p><p>
The handler function is where the marshalling happens
<pre>
<code>
    @staticmethod
    def handler(name, args, kwargs):
</code>
</pre>
We must iterate through all of the function definitions recorded with
the same name, checking each one for candidacy.
<pre>
<code>
        for fn, spec, _prototype, _valuemap in prototype._registry[name]:
</code>
</pre>
We build a dictionary containing the parameter names and their default
values for the selected function instance.
<pre>
<code>
            instance_parameters = OrderedDict(
                zip(
                    spec.args,
                    [] if spec.defaults is None else spec.defaults,
                )
            )

</code>
</pre>
Then we update the dictionary with the positional parameters passed in the
current call attempt
<pre>
<code>
            instance_parameters.update(
                zip(
                    spec.args,
                    args,
                )
            )
</code>
</pre>
And then update the dictionary with the keyword arguments passed in the
current call attempt
<pre>
<code>
            instance_parameters.update(kwargs)
</code>
</pre>
We're careful to exclude cases where there are keyword arguments that don't
match or not all of the provided parameters are assigned to named arguments
<pre>
<code>
            if len(instance_parameters) < len(args):
                continue
            elif set(kwargs.keys()).difference(instance_parameters.keys()):
                continue

</pre>
</code>
Now, prepare a dictionary representing the signature of the current function
using the types of the parameters that were passed
<pre>
<code>
            instance_prototype = {
                _key: type(_value) for _key, _value in instance_parameters.iteritems()
            }
</code>
</pre>
If they don't match, this function is not the right candidate
<pre>
<code>
            if _prototype != instance_prototype:
                continue
</code>
</pre>
Iterate over the parameter values and see if the value specification for the
parameter is None (any value) or, if there is a collection, then determine if
the parameter is within the permissible values. As soon as function parameter
value is deemed inconsistent, then the loop is exited early. If the loop reaches
the end of the parameters without failing, then the function is called immediately
<pre>
<code>

            for key, value in instance_parameters.iteritems():
                permitted = _valuemap.get(key)

                if permitted is None or value in permitted:
                    continue

                # Found non permissible value
                break
            else:
                # All values were found to be permissible
                return fn(**instance_parameters)
</code>
</pre>
If no match is found, then the function, as called, is unimplemented
<pre>
<code>
        raise NotImplementedError("Function '%s' cannot be found with the expressed signature" % (name))
</code>
</pre>
The class can be immediately used at this point, so something like
<pre>
<code>
@prototype(a=float)
def myfunction(a):
    print "FLOAT", a
</code>
</pre>
is possible
</p>
<p>
We can even simulate the Erlang cascading call
<pre>
<code>
@prototype(name=str)
def start_service(name):
    print "Calling start service with %s and %s" % (name, [])
    return start_service(name, [])

@prototype(name=str, args=list)
def start_service(name, args):
    print "Calling start service as tag %s with %s and %s" % (name, name, args)
    return start_service(name, name, args)

@prototype(service_tag=str, name=str, args=list)
def start_service(service_tag, name, args):
    print "Starting service as %s with module %s and parameters %s" % (service_tag, name, args)
</code>
</pre>
On execution, this yields
<pre>
<code>
>>> start_service("fred")

Calling start service with fred and []
Calling start service as tag fred with fred and []
Starting service as fred with module fred and parameters []
</code>
</pre>
</p>
<p>
I'm certain that there are ways to improve the (probably slow) function lookup method,
but, at the least, this benefits by 'hiding' the value and type comparisons that would
otherwise be done in plain view by a function that supported multiple call patterns
</p>
</p>
I hope you liked that !
<p>
</section><section id="2014-09-01" class="blog-entry">

<a class="jumpto" name="2014-09-01"></a>

<header class="post-header">
    <span class="post-meta">
        <time datetime="2014-09-01">
            September 01, 2014
        </time>
    </span>

    <h2 class="post-title">Python Decorator Fun #1</h2>
</header>

            <p>
Given the title's attached serial number, it would seem like this would
portend an ongoing saga of python decorators ad nauseam. However, I promise
not to bore you to tears (well, almost)
            </p>
            <p>
The intent of this post and any to follow are to demonstrate interesting
and possibly helpful applications of decorator logic, where decorators
themselves promise simpler, more fathomable code.
            </p>
            <p>
Did you ever wish that you could access an object member like it was an
array, but "catch" the subscript and produce a result algorithmically
instead ?
            </p>
Well, have no fear. We will present an interface for just such a beast: The
subscripted decorator.
            <p>
            </p>
We can jump right to a provoking use case. Here we instantiate our demo
object, which is pretending to "hold" a range of numbers from 5 to 11
<pre>
<code>
obj = MyRangeHandler(5, 12)
</code>
</pre>

Let's look at the simple values
<pre>
<code>
print obj.values

[5, 6, 7, 8, 9, 10, 11]
</code>
</pre>
            <p>
So let's get the square of the value at position 2 (7)
<pre>
<code>
print obj.squares[2]

49
</code>
</pre>
            </p>
            <p>
Get it ? However, we don't have to store the square values ahead of time, we can
compute them based on the index passed on the original values
            </p>
            <p>
So, let's see how this is implemented...
            </p>
            <p>
First, we'll need functools
<pre>
<code>
from functools import wraps
</code>
</pre>
            </p>

<p>
We'll define a function that'll produce our decorated method
<pre>
<code>
def subscripted(function_reference):
</code>
</pre>
            <p>
This needs to return a wrapped inner function...
<pre>
<code>
    @wraps(function_reference)
    def wrapper(obj, *args, **kwargs):
</code>
</pre>
            </p>
            <p>
Inside that, we define a class whose sole purpose is to implement
the subscripting protocol's lookup method __getitem__()
<pre>
<code>
        class subscripter(object):
            def __getitem__(self, key):
                return function_reference(obj, key)
</code>
</pre>
            </p>
            <p>
Notice that all it does is call the original object method with the
lookup key that the wrapper caller provided. Now we tell the wrapper to return
an instance of the newly defined class, which has captured the outer
object's reference.
<pre>
<code>
        return subscripter()
</code>
</pre>
            </p>
            <p>
And, we have the decorator method return the wrapper as a property of
of the enclosing object, so it will fetch a new subscripter object
whenever we use the . accessor on the decorated method name.
<pre>
<code>
    return property(wrapper)
</code>
</pre>

<p>
Now, we can create our MyRangeHandler class
<pre>
<code>
class MyRangeHandler(object):
    def __init__(self, start, finish):
        self.values = range(start, finish, 1)
</code>
</pre>
</p>

<p>
And let's implement the squared attribute...
<pre>
<code>
    @subscripted
    def squared(self, index):
        return self.values[index] ** 2
</code>
</pre>
</p>

<p>
    And that's it. This use case can obviously be handled using
normal function-style decomposition or simply storing all computable
values. But, there may be cases where subscript lookup is more "natural"
and precomputation is too expensive.
</p>

<p>
This example doesn't allow for fetching all of the square values, however,
since the subscripter class doesn't support slicing, and isn't a "proper"
standin for a list object in any case.
</p>

<p>
Hope you found that useful !
</p>
</section><section id="2014-08-27" class="blog-entry">

<a class="jumpto" name="2014-08-27"></a>

<header class="post-header">
    <span class="post-meta">
        <time datetime="2014-08-27">
            August 27, 2014
        </time>
    </span>

    <h2 class="post-title">Finding Paradise ?</h2>
</header>

<p>
Is there anywhere that could truly be called paradise ?
</p>
<p>
Perhaps not, but, when the sun rises after an all night coding session, or the night job
we had to take to service the mortgage when wages were cut, or even if it's
the only job we could get, we should still take a second to look outside, at that golden sun rising over the turqouise
water, and remember, that whatever trouble befalls us, we still can have something to
speak the meaning to life.
</p>
<hr>
<p>
We're starting to get our geek community to come together. The google group is
    <a href="https://groups.google.com/forum/#!forum/open-bermuda">here</a>.
There have been various attempts in, for instance, the dotNet and Arduino circles,
and there is a robotics club as well as <a href="http://bermuda.io/">Bermuda.io</a>
which leans toward opening public data for analysis from a general position that all such
data should be open (highly admirable).
</p>
<p>
Open Bermuda attempts to form a general community of technological enthusiasts, where
sustaining such a community causes a perpetual cycle of circulating ideas and knowledge
transfer between people interested in such fields as Mathematics, Programming, Biology,
Oceanography, Public Policy, Climate Science, Electrical Engineering, Robotics ... Ok,
there's just too much to list, but you get the picture.
</p>
<p>
If everyone works to keep the community at or above critical mass, then it should all work
as planned and we'll make not only Bermuda a better place, but the World, too.
</p>
</section>
    </div>
</div>
</body>
</html>
